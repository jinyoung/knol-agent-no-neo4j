from legal_doc_processor import create_legal_doc_processor, GraphState, Node, process_document_chunk

def test_legal_doc_processing_ko():
    # 프로세서 생성
    processor = create_legal_doc_processor()
    
    # 기본 세금 규정 노드로 초기 상태 초기화
    initial_state = GraphState(
        nodes={
            "node_1": Node(
                content="기업의 세금 공제는 과세 연도 동안 발생한 일반적이고 필요한 사업 비용에 대해 허용됩니다.",
                node_type="tax_regulation"
            )
        }
    )
    
    # 세금 규정의 다양한 측면을 나타내는 테스트 청크들
    chunks = [
        # 청크 1: 기본 정의와 기준 (보완적 정보)
        """
        사업 비용은 세금 공제 대상이 되려면 일반적이면서 필요한 것이어야 합니다.
        일반적인 비용이란 해당 산업에서 통상적이고 인정되는 비용을 의미합니다.
        필요한 비용이란 사업에 도움이 되고 적절한 비용을 의미합니다.
        해당 비용은 사업과 직접적인 관련이 있어야 하며, 상황에 비해 과도하거나 사치스럽지 않아야 합니다.
        """,
        
        # 청크 2: 자본 지출 정보 (관계가 있는 새로운 카테고리)
        """
        자본 지출은 사업 비용으로 공제될 수 없습니다. 이는 사업에 대한 투자의 일부이며 일반적으로 자본화됩니다.
        여기에는 사업 시작 비용, 사업 자산, 그리고 자산의 가치를 증가시키거나 유용성을 높이거나 수명을 연장하는
        개선 비용이 포함됩니다.
        """,
        
        # 청크 3: 조건부 모순 (창업 비용 예외)
        """
        이전 규정과는 달리, 최근 조세법원 판결에 따르면 특정 사업 시작 비용은 여러 해에 걸쳐 자본화하는 대신
        운영 첫 해에 일반 사업 비용으로 공제할 수 있습니다. 이는 특별히 5,000달러 미만의 창업 비용에 적용됩니다.
        """,
        
        # 청크 4: 오버플로우를 유발하는 대형 청크 (상세 공제 유형)
        """
        공제 가능한 사업 비용에는 다음이 포함됩니다: 사업용 부동산 임대료; 직원 급여; 수리 및 유지보수;
        공공요금; 사무용품; 출장비; 사업상 식사비(50% 한도 공제); 사업 보험; 법률 및 전문가 수수료;
        직원 퇴직 연금; 사업 대출 이자; 사업 장비 감가상각; 광고비; 사업세 및 면허비; 직원 복리후생 프로그램;
        직원 보험. 각 카테고리별로 공제 자격을 얻기 위해 충족해야 하는 특정 요구사항과 제한이 있습니다.
        요구사항은 비용 유형에 따라 다르며 세법의 연간 변경사항에 따라 달라질 수 있습니다.
        문서화 요구사항도 비용 카테고리별로 다릅니다.
        """,
        
        # 청크 5: 조건부 모순 (코로나 시기 식사비)
        """
        2021년과 2022년 과세연도 동안 레스토랑에서 구매한 사업 식사비는 코로나19 팬데믹으로부터
        요식업계의 회복을 돕기 위한 임시 조치로 100% 공제됩니다. 다른 모든 과세연도에 대해서는
        표준 규정에 따라 식사비 공제 50% 제한이 적용됩니다.
        """,
        
        # 청크 6: 차량 비용 (상세 하위 카테고리)
        """
        사업용 차량 비용은 표준 마일리지율 방식 또는 실제 비용 방식의 두 가지 방법으로 공제될 수 있습니다.
        표준 마일리지율은 매년 국세청이 정하며 2023년의 경우 마일당 65.5센트입니다. 실제 비용 방식은
        사업 사용 비율에 따라 연료, 보험, 수리, 감가상각을 포함한 모든 차량 운영 비용의 공제를 허용합니다.
        """,
        
        # 청크 7: 정보 삭제
        """
        2025년 1월 1일부터 사업 장비의 감가상각에 관한 섹션은 별도로 발표될 새로운 규정으로 대체되므로
        무시해야 합니다.
        """,
        
        # 청크 8: 다중 정보 유형 (접대비 및 적격 개선 자산)
        """
        2017년 감세 및 일자리법 이후 접대비는 어떤 경우에도 더 이상 공제되지 않습니다.
        적격 개선 자산(QIP)은 감세 및 일자리법의 기술적 수정으로 보너스 감가상각 대상이 되었습니다.
        QIP에는 비주거용 건물 내부의 개선이 포함되지만, 확장, 엘리베이터/에스컬레이터, 내부 구조
        프레임워크는 제외됩니다.
        """,
        
        # 청크 9: 상호 참조 정보
        """
        179조 공제는 기업이 해당 과세연도에 구매한 적격 장비 및 소프트웨어의 전체 구매가격을 제한 내에서
        공제할 수 있게 합니다. 이 조항은 자본 지출 섹션에서 언급된 자본화 규칙과 직접적으로 관련되지만
        해당 일반 규칙에 대한 예외를 만듭니다.
        """,
        
        # 청크 10: 조건부 관계
        """
        최소 허용 한도 선택은 매년 특정 항목을 비용 처리할 수 있게 합니다: 해당 사업체가 적용 가능한
        재무제표(AFS)가 없는 경우 항목당 2,500달러 미만, AFS가 있는 경우 항목당 5,000달러 미만.
        이는 과세연도 시작 시점에 적격한 회계 절차를 갖춘 납세자에게만 적용됩니다.
        """
    ]
    
    # 각 청크를 처리하고 지식 그래프의 진화를 추적
    current_state = initial_state
    for i, chunk in enumerate(chunks, 1):
        print(f"\n청크 {i} 처리 중...")
        current_state = process_document_chunk(processor, current_state, chunk)
        
        # 지식 그래프의 현재 상태 출력
        print(f"\n청크 {i} 이후의 지식 그래프:")
        if current_state.nodes:
            for node_id, node in current_state.nodes.items():
                print(f"\n노드 {node_id} ({node.node_type}):")
                print(f"내용: {node.content}")
                if node.relationships:
                    print("관계:", node.relationships)
                if node.metadata:
                    print("메타데이터:", node.metadata)
        else:
            print("지식 그래프에 노드가 없습니다.")
        print("\n" + "="*80)

if __name__ == "__main__":
    test_legal_doc_processing_ko() 